# Workflow para compilar iOS sin tener Mac
# GRATIS si tu repo es p√∫blico en GitHub
# NO requiere certificados - Solo para desarrollo/pruebas

name: Build iOS App (Simulator, no signing)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  ios-sim-build:
    runs-on: macos-latest
    env:
      NODE_OPTIONS: --max-old-space-size=4096

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verificar versiones de Node.js y npm
        run: |
          echo "=== Versiones instaladas ==="
          node -v
          npm -v
          NODE_VERSION=$(node --version | sed 's/v//')
          NODE_MAJOR=$(echo $NODE_VERSION | cut -d. -f1)
          
          if [ "$NODE_MAJOR" -lt 20 ]; then
            echo "‚ùå ERROR: Node.js $NODE_VERSION es menor que 20.0.0"
            echo "Capacitor CLI requiere Node.js >=20.0.0"
            exit 1
          fi
          echo "‚úÖ Node.js $NODE_VERSION cumple el requisito >=20.0.0"

      - name: Instalar dependencias npm
        run: npm ci

      - name: Instalar Capacitor CLI
        run: |
          npm install --no-save @capacitor/cli@latest
          echo "‚úÖ Capacitor CLI instalado"
          npx cap --version

      - name: Instalar Capacitor iOS
        run: npm install @capacitor/ios

      - name: Build web app
        run: npm run build

      - name: Verificar Node.js y Capacitor antes de ejecutar
        run: |
          echo "=== Verificaci√≥n final antes de Capacitor ==="
          NODE_VERSION=$(node --version | sed 's/v//')
          NODE_MAJOR=$(echo $NODE_VERSION | cut -d. -f1)
          echo "Node.js version: $NODE_VERSION"
          echo "npm version: $(npm --version)"
          
          if [ "$NODE_MAJOR" -lt 20 ]; then
            echo "‚ùå ERROR: Node.js $NODE_VERSION es menor que 20.0.0"
            exit 1
          fi
          
          echo "Capacitor CLI version:"
          npx cap --version || echo "‚ö†Ô∏è Capacitor CLI no encontrado"
          echo "‚úÖ Todo listo para ejecutar Capacitor"

      - name: Agregar plataforma iOS
        run: npx cap add ios || true

      - name: Sincronizar iOS
        run: npx cap sync ios

      - name: Setup Ruby & CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Instalar CocoaPods
        run: |
          gem install cocoapods --no-document
          cd ios || exit 0
          pod install --repo-update || true
          cd ..

      - name: Listar simuladores disponibles (debug)
        run: |
          echo "=== Simuladores disponibles ==="
          xcrun simctl list devices available | grep "iPhone" || true

      - name: Detectar simulador disponible
        id: simulator
        run: |
          echo "=== Detectando simulador disponible ==="
          DEVICE_LIST=$(xcrun simctl list devices available)
          echo "$DEVICE_LIST"
          
          # Prioridad 1: iPhone SE (3rd generation) - disponible en GitHub Actions
          if echo "$DEVICE_LIST" | grep -q "iPhone SE (3rd generation)"; then
            DEST_NAME="iPhone SE (3rd generation)"
            echo "‚úÖ Usando simulador preferido: $DEST_NAME"
          # Prioridad 2: Cualquier iPhone SE
          elif echo "$DEVICE_LIST" | grep -q "iPhone SE"; then
            DEST_NAME=$(echo "$DEVICE_LIST" | grep "iPhone SE" | head -1 | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
            echo "‚úÖ Usando: $DEST_NAME"
          # Prioridad 3: Cualquier iPhone disponible
          else
            DEST_NAME=$(echo "$DEVICE_LIST" | grep "iPhone" | head -1 | sed -E 's/^[[:space:]]*([^(]+).*/\1/' | xargs)
            if [ -z "$DEST_NAME" ]; then
              # √öltimo intento: extraer cualquier iPhone de la lista
              DEST_NAME=$(echo "$DEVICE_LIST" | grep -Eo 'iPhone [^()]+' | head -n1 | sed 's/ *$//' || echo "")
            fi
            echo "‚úÖ Usando simulador disponible: $DEST_NAME"
          fi
          
          if [ -z "$DEST_NAME" ]; then
            echo "‚ùå No se encontr√≥ un simulador iPhone disponible."
            echo "=== Lista completa de dispositivos ==="
            xcrun simctl list devices
            exit 1
          fi
          
          echo "simulator_name=$DEST_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Simulador seleccionado: $DEST_NAME"

      - name: Build para iOS Simulator (sin code signing)
        run: |
          # Ajusta estas rutas/nombres seg√∫n tu proyecto
          WORKSPACE="ios/App/App.xcworkspace"
          SCHEME="App"
          
          SIMULATOR_NAME="${{ steps.simulator.outputs.simulator_name }}"
          
          if [ -z "$SIMULATOR_NAME" ]; then
            echo "‚ùå No se pudo determinar el simulador"
            exit 1
          fi
          
          DEST="platform=iOS Simulator,OS=latest,name=$SIMULATOR_NAME"
          echo "=== Construyendo para simulador: $DEST ==="
          
          cd ios/App || cd ios || exit 1
          
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme "$SCHEME" \
                     -sdk iphonesimulator \
                     -configuration Debug \
                     -destination "$DEST" \
                     clean build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     DEVELOPMENT_TEAM=""

      - name: Crear app bundle para simulador
        run: |
          echo "‚úÖ Build completado para simulador iOS"
          echo "üì± La app est√° lista para ejecutar en simulador"
          echo ""
          echo "Para usar:"
          echo "1. Descarga los artefactos"
          echo "2. Abre el proyecto en Xcode (si tienes Mac)"
          echo "3. O usa como PWA en iPhone Safari"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-simulator
          path: |
            ios/App/build/
            ios/App/App.xcworkspace
          retention-days: 7
          if-no-files-found: warn

      - name: Crear PWA build (Funciona en iOS sin compilar)
        run: |
          echo "üì± Tambi√©n puedes usar la app como PWA en iOS:"
          echo "1. Despliega dist/ a Netlify/Vercel"
          echo "2. Abre en Safari en iPhone"
          echo "3. Safari ‚Üí Compartir ‚Üí 'Agregar a pantalla de inicio'"
          echo "4. ¬°Funciona como app nativa sin compilar!"

      - name: Upload PWA build
        uses: actions/upload-artifact@v4
        with:
          name: pwa-build
          path: dist/
          retention-days: 7
          if-no-files-found: warn
