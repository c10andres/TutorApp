rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función helper para verificar que el usuario es el dueño
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Función helper para verificar que el documento existe
    function documentExists(path) {
      return exists(path);
    }
    
    // ===================
    // COLECCIÓN: users
    // ===================
    match /users/{userId} {
      // Leer: Solo el propio usuario o cualquier usuario autenticado (para ver perfiles públicos)
      allow read: if isAuthenticated();
      
      // Crear: Solo durante el registro (el usuario crea su propio documento)
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Actualizar: Solo el propio usuario
      allow update: if isOwner(userId);
      
      // Eliminar: Solo el propio usuario
      allow delete: if isOwner(userId);
      
      // Subcolección: reviews (reseñas recibidas por el tutor)
      match /reviews/{reviewId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }
    
    // ===================
    // COLECCIÓN: tutoring_requests
    // ===================
    match /tutoring_requests/{requestId} {
      // Leer: Solo los usuarios involucrados (estudiante o tutor)
      allow read: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.tutorId == request.auth.uid);
      
      // Crear: Cualquier usuario autenticado puede crear una solicitud
      allow create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
      
      // Actualizar: Solo estudiante o tutor involucrados
      allow update: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.tutorId == request.auth.uid);
      
      // Eliminar: Solo el estudiante que creó la solicitud
      allow delete: if isAuthenticated() && 
        resource.data.studentId == request.auth.uid;
    }
    
    // ===================
    // COLECCIÓN: chats
    // ===================
    match /chats/{chatId} {
      // Leer: Solo los participantes del chat
      allow read: if isAuthenticated() && 
        (request.auth.uid in resource.data.participants);
      
      // Crear: Cualquier usuario autenticado
      allow create: if isAuthenticated() && 
        (request.auth.uid in request.resource.data.participants);
      
      // Actualizar: Solo los participantes
      allow update: if isAuthenticated() && 
        (request.auth.uid in resource.data.participants);
      
      // Subcolección: messages
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          (request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        allow create: if isAuthenticated() && 
          request.resource.data.senderId == request.auth.uid;
        
        allow update: if isAuthenticated();
      }
    }
    
    // ===================
    // COLECCIÓN: reviews
    // ===================
    match /reviews/{reviewId} {
      // Leer: Cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Crear: Solo el estudiante que completó la tutoría
      allow create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
      
      // Actualizar: Solo el autor de la reseña (dentro de 24 horas)
      allow update: if isAuthenticated() && 
        resource.data.studentId == request.auth.uid &&
        request.time < resource.data.createdAt + duration.value(1, 'd');
      
      // Eliminar: Solo el autor o el tutor puede reportar/eliminar
      allow delete: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.tutorId == request.auth.uid);
    }
    
    // ===================
    // COLECCIÓN: payments
    // ===================
    match /payments/{paymentId} {
      // Leer: Solo los usuarios involucrados
      allow read: if isAuthenticated() && 
        (resource.data.studentId == request.auth.uid || 
         resource.data.tutorId == request.auth.uid);
      
      // Crear: Solo el estudiante
      allow create: if isAuthenticated() && 
        request.resource.data.studentId == request.auth.uid;
      
      // Actualizar: Sistema (vía Cloud Functions) - Por ahora, solo lectura
      allow update: if false;
      
      // No se puede eliminar
      allow delete: if false;
    }
    
    // ===================
    // COLECCIÓN: transactions
    // ===================
    match /transactions/{transactionId} {
      // Leer: Solo el dueño de la transacción
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // No se puede crear manualmente (solo vía backend)
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
    
    // ===================
    // COLECCIÓN: notifications
    // ===================
    match /notifications/{notificationId} {
      // Leer: Solo el destinatario
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Crear: Cualquier usuario autenticado
      allow create: if isAuthenticated();
      
      // Actualizar: Solo el destinatario (marcar como leída)
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el destinatario
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ===================
    // COLECCIÓN: semesters (Gestión Académica)
    // ===================
    match /semesters/{semesterId} {
      // Leer: Solo el dueño
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Crear: Solo el usuario autenticado para sí mismo
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo el dueño
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el dueño
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Subcolección: subjects (materias del semestre)
      match /subjects/{subjectId} {
        allow read, write: if isAuthenticated() && 
          get(/databases/$(database)/documents/semesters/$(semesterId)).data.userId == request.auth.uid;
      }
    }
    
    // ===================
    // COLECCIÓN: documents (Documentos Universitarios)
    // ===================
    match /documents/{documentId} {
      // Leer: Según privacidad del documento
      allow read: if isAuthenticated() && 
        (resource.data.privacy == 'public' || 
         resource.data.userId == request.auth.uid);
      
      // Crear: Cualquier usuario autenticado
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo el creador
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el creador
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ===================
    // COLECCIÓN: universityDocs (Documentos Universitarios Oficiales)
    // ===================
    match /universityDocs/{documentId} {
      // Leer: Cualquier usuario autenticado puede leer documentos universitarios
      allow read: if isAuthenticated();
      
      // Crear: Solo usuarios autenticados (administradores)
      allow create: if isAuthenticated();
      
      // Actualizar: Solo usuarios autenticados (administradores)
      allow update: if isAuthenticated();
      
      // Eliminar: Solo usuarios autenticados (administradores)
      allow delete: if isAuthenticated();
    }
    
    // ===================
    // COLECCIÓN: study_plans (Smart Study Planner)
    // ===================
    match /study_plans/{planId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Subcolección: tasks
      match /tasks/{taskId} {
        allow read, write: if isAuthenticated() && 
          get(/databases/$(database)/documents/study_plans/$(planId)).data.userId == request.auth.uid;
      }
    }
    
    // ===================
    // COLECCIÓN: support_tickets (Soporte)
    // ===================
    match /support_tickets/{ticketId} {
      // Leer: Solo el creador del ticket
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Crear: Cualquier usuario autenticado
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo el creador
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Subcolección: messages (mensajes del ticket)
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/support_tickets/$(ticketId)).data.userId == request.auth.uid;
        
        allow create: if isAuthenticated();
      }
    }
    
    // ===================
    // COLECCIÓN: analytics (Predictor Académico)
    // ===================
    match /analytics/{userId} {
      allow read: if isAuthenticated() && userId == request.auth.uid;
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }
    
    // ===================
    // COLECCIÓN: studyGoals (Smart Study Planner - Objetivos de Estudio)
    // ===================
    match /studyGoals/{goalId} {
      // Leer: Solo el dueño del objetivo
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Crear: Solo el usuario autenticado para sí mismo
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo el dueño
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el dueño
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ===================
    // COLECCIÓN: studySessions (Smart Study Planner - Sesiones de Estudio)
    // ===================
    match /studySessions/{sessionId} {
      // Leer: Solo el dueño de la sesión
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Crear: Solo el usuario autenticado para sí mismo
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Actualizar: Solo el dueño
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Eliminar: Solo el dueño
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // ===================
    // BLOQUEAR TODO LO DEMÁS
    // ===================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
